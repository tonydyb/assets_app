# 4️⃣ 低级设计文档（LLD）

版本：1.3  
作者：Tei  
日期：2026-02-14

## 1. 目的

本文档基于当前代码实现（`main.js`、`preload.js`、`main/`、`renderer/`）描述实际低级设计，确保实现与文档一致。

## 2. 运行架构

- 桌面框架：Electron
- 数据库：SQLite（通过 `sql.js` WASM 驱动）
- 架构：Main 进程 + Renderer 进程 + Preload 安全桥
- 入口页面：`renderer/dashboard.html`

## 3. 代码结构（与当前工程一致）

```text
assets_app/
├─ main.js
├─ preload.js
├─ main/
│  ├─ assetService.js
│  ├─ database.js
│  └─ config.js
├─ renderer/
│  ├─ dashboard.html
│  ├─ assets.html
│  ├─ add_asset.html
│  ├─ asset_types.html
│  ├─ chart.html
│  ├─ app-react.js
│  ├─ renderer.js (legacy, currently unused)
│  └─ mvp.css
└─ data/
   └─ assets.db
```

## 4. 模块职责

### 4.1 `main.js`

- 创建 BrowserWindow（`1000 x 720`）
- 安全配置：
  - `contextIsolation: true`
  - `nodeIntegration: false`
- 加载 `renderer/dashboard.html`
- 在 `app.whenReady()` 中调用 `assetService.init()` 初始化数据库
- 注册 IPC handlers

### 4.2 `preload.js`

通过 `contextBridge.exposeInMainWorld('api', ...)` 暴露白名单函数：

- `getAssets()`
- `getLatestAssets()`
- `getConfig()`
- `addAsset(asset)`
- `deleteAsset(id)`
- `modifyAsset(asset)`
- `getAssetTypes()`
- `addAssetType(name)`
- `deleteAssetType(id)`
- `modifyAssetType(id, name)`

### 4.3 `main/database.js`

- 使用 `sql.js` 初始化数据库
- 数据文件路径：`data/assets.db`
- 初始化时自动建表（若不存在）
- 封装 `dbWrapper.prepare(sql)`：
  - `run(...params)`：执行写操作并立即 `saveDb()`
  - `all(...params)`：返回对象数组

### 4.4 `main/assetService.js`

封装业务与 SQL：

- 资产：`getAssets`、`getLatestAssets`、`addAsset`、`modifyAsset`、`deleteAsset`
- 类型：`getAssetTypes`、`addAssetType`、`modifyAssetType`、`deleteAssetType`
- 删除类型前会检查是否被资产引用，被引用时返回 `error` 文本

### 4.5 `renderer/app-react.js`

使用 React 组件按页面进行渲染：

- `DashboardPage`：Dashboard 总额与最近资产
- `AssetsPage`：资产列表、Duplicate/Edit/Delete
- `AddAssetPage`：新增资产 + sessionStorage 预填
- `AssetTypesPage`：类型管理（新增、编辑、删除）
- `ChartPage`：Canvas 柱状图
- React 运行时来源：`renderer/vendor/react.production.min.js`、`renderer/vendor/react-dom.production.min.js`

## 5. IPC 合约（实际实现）

> 当前使用“函数名式 channel”，非 `assets:*` 命名。

| Channel | 入参 | 返回 |
|---|---|---|
| `getAssets` | 无 | 资产列表 |
| `getLatestAssets` | 无 | 最新日期的资产列表 |
| `getConfig` | 无 | `{ JPY_PER_CNY }` |
| `addAsset` | `{ date, typeId, name, amount, currency }` | `{ lastInsertRowid }` |
| `modifyAsset` | `{ id, date, typeId, name, amount, currency }` | `{ changes }` |
| `deleteAsset` | `id` | `{ changes }` |
| `getAssetTypes` | 无 | 类型列表 |
| `addAssetType` | `name` | `{ lastInsertRowid }` |
| `modifyAssetType` | `id, name` | `{ changes }` |
| `deleteAssetType` | `id` | `{ success, changes }` 或 `{ error }` |

## 6. 数据库设计（实际表结构）

### 6.1 `asset_types`

```sql
CREATE TABLE IF NOT EXISTS asset_types (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT UNIQUE NOT NULL
);
```

### 6.2 `assets`

```sql
CREATE TABLE IF NOT EXISTS assets (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  date TEXT NOT NULL,
  type_id INTEGER,
  name TEXT,
  amount REAL DEFAULT 0,
  currency TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY(type_id) REFERENCES asset_types(id)
);
```

## 7. 关键业务规则

- Dashboard 仅显示“最新日期”资产（`getLatestAssets`）
- Dashboard 总额按 JPY 展示：
  - 若币种是 `CNY`，使用 `JPY_PER_CNY` 换算
  - 默认换算比来自 `main/config.js`：`100 / 4.5`
- 图表按“日期聚合后的 JPY 值”绘制
- 资产 Duplicate：点击后将原记录写入 `sessionStorage.prefillAsset` 并跳转新增页
- 类型删除保护：被资产引用时禁止删除

## 8. 页面与逻辑映射

- `dashboard.html` + `DashboardPage`
- `assets.html` + `AssetsPage`（含内联编辑面板）
- `add_asset.html` + `AddAssetPage`
- `asset_types.html` + `AssetTypesPage`（含内联编辑面板）
- `chart.html` + `ChartPage`

## 9. 已实现与未实现边界

### 9.1 已实现

- 资产/类型的基本 CRUD
- 最新日期资产总览
- React 组件化 Renderer
- 简单汇率换算（CNY -> JPY）
- Canvas 柱状图

### 9.2 当前未实现（文档不再假设已具备）

- 统一结构化错误码体系
- 通用 `invoke(channel, payload)` 白名单校验
- 迁移系统（`migrations` 表）
- CSV 导出、数据库备份/恢复
- 分页、筛选、高级查询

## 10. 维护建议

- 若后续引入迁移与备份能力，建议新增 `main/migrations/` 并在 `database.js` 增加版本管理。
- 若后续扩展币种与汇率，建议在 `config.js` 升级为多币种映射并补充汇率更新时间。
- 后续可移除 `renderer/renderer.js` 遗留文件，避免维护歧义。
