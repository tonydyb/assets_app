# 4️⃣ 低级设计文档（LLD）

版本：1.4  
作者：Tei  
日期：2026-02-15

## 1. 目的

本文档在现有实现基础上，补齐与 HLD 一致的多语言与多币种低级设计，统一术语：

- `settings`
- `exchange_rates`
- `i18n fallback`
- `fx 状态`

## 2. 模块划分（vNext）

### 2.1 Renderer（React）

职责：

- 渲染多语言文案
- 提供语言切换入口
- 提供显示币种切换入口
- 展示汇率状态（正常/过期/缺失）

### 2.2 i18n 模块

职责：

- 加载语言资源
- 根据 `settings.app.language` 选择当前语言
- 执行缺失翻译回退

回退规则（固定）：

1. 当前语言
2. `en-US`
3. `zh-CN`
4. 文案 key

### 2.3 fx/exchange-rate 模块

职责：

- 读取 `settings.app.display_currency`
- 查询 `exchange_rates`
- 提供资产金额换算
- 输出 `fx 状态`

`fx 状态` 枚举：

- `ok`：汇率存在且未过期
- `stale`：汇率存在但已过期
- `missing`：目标汇率缺失

### 2.4 Service 层

职责：

- 聚合资产
- 调用 fx 模块进行换算
- 汇总 fx 状态信息
- 将结果返回给 UI

## 3. 配置键设计（settings）

- `app.language`: `zh-CN` / `en-US` / `ja-JP`
- `app.display_currency`: `JPY` / `CNY` / `USD`
- `fx.cache_ttl_days`: 正整数

## 4. IPC 合约（新增/扩展）

### 4.1 i18n 相关

- `getSettings` -> 入参 `无` -> 返回 `{ [key]: value }`
- `setSetting` -> 入参 `{ key, value }` -> 返回 `{ changes }`

### 4.2 fx 相关

- `getExchangeRates` -> 入参 `无` -> 返回 `[{ base_currency, quote_currency, rate, source, updated_at }]`
- `upsertExchangeRate` -> 入参 `{ baseCurrency, quoteCurrency, rate }` -> 返回 `{ success, changes } | { error }`
- 设置页直接调用 `upsertExchangeRate` 写入数据库（手工维护汇率）
- `assets:getSummary`（规划）-> 入参 `{ displayCurrency? }` -> 返回

```json
{
  "displayCurrency": "JPY",
  "total": 123456.78,
  "fx": {
    "status": "ok|stale|missing",
    "updatedAt": "2026-02-15T00:00:00Z",
    "missingPairs": ["USD->JPY"],
    "excludedCount": 2
  }
}
```

## 5. UI 渲染约定

### 5.1 多语言渲染

- 所有固定文案从 i18n 字典读取。
- 缺失翻译必须按 fallback 规则显示，不允许空白。

### 5.2 多币种渲染

- Dashboard/Chart 使用同一 `displayCurrency`。
- 当 `fx.status = missing`：
  - 页面显示“缺少汇率”提示；
  - 显示未计入汇总数量。
- 当 `fx.status = stale`：
  - 页面显示“汇率已过期”提示；
  - 允许继续显示换算结果。

## 6. 换算规则

### 6.1 单资产换算

- 若资产币种 == 显示币种，直接使用原值。
- 否则查找对应汇率并换算。
- 缺失汇率时，该资产标记为 excluded，不计入 total。

### 6.2 汇总换算

- 仅累计可换算或同币种资产。
- 返回 `excludedCount` 和 `missingPairs` 供 UI 提示。

## 7. 离线与缓存策略（LLD 细化）

- 汇率仅从本地 `exchange_rates` 读取。
- 用户手工更新汇率后，立即覆盖同币种对记录（`UNIQUE(base_currency, quote_currency)`）。
- 过期判定：按 `updated_at + fx.cache_ttl_days` 计算有效期。

## 8. 错误与状态返回约定

统一错误结构：

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR|NOT_FOUND|DB_ERROR|FX_RATE_MISSING",
    "message": "..."
  }
}
```

fx 缺失为业务状态优先，不默认抛异常；仅在调用方明确要求 strict mode 时返回 `FX_RATE_MISSING`。

## 9. 渐进落地建议

1. 先落地 `settings` 与 `exchange_rates` 表。  
2. 再落地 `getSettings/setSetting` 与 `getExchangeRates/upsertExchangeRate` IPC。  
3. 最后接入 Dashboard/Chart 与 i18n 文案切换（已开始落地）。
