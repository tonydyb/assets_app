# 4️⃣ 低级设计文档（LLD）

版本：1.4  
作者：Tei  
日期：2026-02-15

## 1. 目的

本文档在现有实现基础上，补齐与 HLD 一致的多语言与多币种低级设计，统一术语：

- `settings`
- `exchange_rates`
- `i18n fallback`
- `fx 状态`

## 2. 模块划分（vNext）

### 2.1 Renderer（React）

职责：

- 渲染多语言文案
- 提供语言切换入口
- 提供显示币种切换入口
- 展示汇率状态（正常/过期/缺失）
- 提供数据导出/导入入口与结果提示

### 2.2 i18n 模块

职责：

- 加载语言资源
- 根据 `settings.app.language` 选择当前语言
- 执行缺失翻译回退

回退规则（固定）：

1. 当前语言
2. `en-US`
3. `zh-CN`
4. 文案 key

### 2.3 fx/exchange-rate 模块

职责：

- 读取 `settings.app.display_currency`
- 查询 `exchange_rates`
- 提供资产金额换算
- 输出 `fx 状态`

`fx 状态` 枚举：

- `ok`：汇率存在且未过期
- `stale`：汇率存在但已过期
- `missing`：目标汇率缺失

### 2.4 Service 层

职责：

- 聚合资产
- 调用 fx 模块进行换算
- 汇总 fx 状态信息
- 将结果返回给 UI
- 提供数据库导入/导出能力（调用数据库模块）

## 3. 配置键设计（settings）

- `app.language`: `zh-CN` / `en-US` / `ja-JP`
- `app.display_currency`: `JPY` / `CNY` / `USD`
- `fx.cache_ttl_days`: 正整数

## 4. IPC 合约（新增/扩展）

### 4.1 i18n 相关

- `getSettings` -> 入参 `无` -> 返回 `{ [key]: value }`
- `setSetting` -> 入参 `{ key, value }` -> 返回 `{ changes }`

### 4.2 fx 相关

- `getExchangeRates` -> 入参 `无` -> 返回 `[{ base_currency, quote_currency, rate, source, updated_at }]`
- `upsertExchangeRate` -> 入参 `{ baseCurrency, quoteCurrency, rate }` -> 返回 `{ success, changes } | { error }`
- 设置页直接调用 `upsertExchangeRate` 写入数据库（手工维护汇率）
- `exportDatabase` -> 入参 `无` -> 行为：打开保存对话框导出 `.db` -> 返回 `{ success, path } | { canceled } | { error }`
- `importDatabase` -> 入参 `无` -> 行为：打开文件对话框导入 `.db` -> 返回 `{ success, willRestart, backupPath } | { canceled } | { error }`
- `assets:getSummary`（规划）-> 入参 `{ displayCurrency? }` -> 返回

```json
{
  "displayCurrency": "JPY",
  "total": 123456.78,
  "fx": {
    "status": "ok|stale|missing",
    "updatedAt": "2026-02-15T00:00:00Z",
    "missingPairs": ["USD->JPY"],
    "excludedCount": 2
  }
}
```

## 5. UI 渲染约定

### 5.1 多语言渲染

- 所有固定文案从 i18n 字典读取。
- 缺失翻译必须按 fallback 规则显示，不允许空白。

### 5.2 多币种渲染

- Dashboard/Chart 使用同一 `displayCurrency`。
- 当 `fx.status = missing`：
  - 页面显示“缺少汇率”提示；
  - 显示未计入汇总数量。
- 当 `fx.status = stale`：
  - 页面显示“汇率已过期”提示；
  - 允许继续显示换算结果。

## 6. 换算规则

### 6.1 单资产换算

- 若资产币种 == 显示币种，直接使用原值。
- 否则查找对应汇率并换算。
- 缺失汇率时，该资产标记为 excluded，不计入 total。

### 6.2 汇总换算

- 仅累计可换算或同币种资产。
- 返回 `excludedCount` 和 `missingPairs` 供 UI 提示。

## 7. 离线与缓存策略（LLD 细化）

- 汇率仅从本地 `exchange_rates` 读取。
- 用户手工更新汇率后，立即覆盖同币种对记录（`UNIQUE(base_currency, quote_currency)`）。
- 过期判定：按 `updated_at + fx.cache_ttl_days` 计算有效期。

## 8. 错误与状态返回约定

统一错误结构：

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR|NOT_FOUND|DB_ERROR|FX_RATE_MISSING",
    "message": "..."
  }
}
```

fx 缺失为业务状态优先，不默认抛异常；仅在调用方明确要求 strict mode 时返回 `FX_RATE_MISSING`。

导入/导出相关错误示例：

- `IMPORT_INVALID_FILE`: 导入文件不存在或不可读
- `IMPORT_INVALID_SCHEMA`: 缺少核心表
- `IMPORT_INTEGRITY_FAILED`: 数据库完整性校验失败
- `EXPORT_IO_ERROR`: 导出写文件失败

## 9. 渐进落地建议

1. 先落地 `settings` 与 `exchange_rates` 表。  
2. 再落地 `getSettings/setSetting` 与 `getExchangeRates/upsertExchangeRate` IPC。  
3. 最后接入 Dashboard/Chart 与 i18n 文案切换（已开始落地）。

## 10. 数据库迁移执行器（已落地）

### 10.1 文件布局

- 迁移脚本目录：`main/migrations/`
- 当前基线脚本：`main/migrations/001_initial_schema.sql`
- 数据库模块：`main/database.js`
- 启动入口：`main.js`（`await assetService.init()` 后再 `createWindow()`）

### 10.2 执行流程

1. 解析并排序 `main/migrations/NNN_*.sql`。  
2. 读取 `PRAGMA user_version` 作为当前版本。  
3. 若存在待执行脚本：
  - 先备份数据库文件到 `userData/backups/`；
  - 对每个脚本执行 `BEGIN -> SQL -> PRAGMA user_version=NNN -> COMMIT`。  
4. 任一脚本失败时 `ROLLBACK`，抛错并终止应用启动。  

### 10.3 路径策略

- 开发环境数据库：`data/assets.db`
- 打包环境数据库：`app.getPath('userData')/assets.db`
- 备份文件命名：
  - `assets.v<from>-to-v<to>.<timestamp>.db`

### 10.4 首启基线数据

由 `001_initial_schema.sql` 一次性建立与注入：

- 表结构：`asset_types`、`assets`、`settings`、`exchange_rates`
- 默认设置：`app.language=en-US`、`app.display_currency=USD`、`fx.cache_ttl_days=90`
- 初始资产类型：`美股`、`中国股票`、`现金人民币`
- 初始资产（仅空库）：`现金人民币`，`10000 CNY`

## 11. 导入/导出执行细节（已落地）

### 11.1 导出流程

1. 设置页触发 `exportDatabase`。  
2. 主进程打开保存对话框并获得目标路径。  
3. 数据库模块先持久化当前内存库，再复制 `assets.db` 到目标路径。  
4. UI 显示导出结果路径。  

### 11.2 导入流程

1. 设置页触发 `importDatabase`，先进行覆盖确认。  
2. 主进程打开文件对话框选择 `.db`。  
3. 数据库模块校验导入文件：
  - `PRAGMA integrity_check = ok`
  - 存在核心表：`asset_types`、`assets`、`settings`、`exchange_rates`  
4. 校验通过后先备份当前数据库到 `userData/backups/`。  
5. 复制导入文件覆盖当前库，随后执行 migration 到最新版本。  
6. 返回成功并触发应用重启。  
